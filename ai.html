
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Companion Chat (HTML)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
 
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #chat-window {
            height: calc(100vh - 180px); 
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        #chat-window::-webkit-scrollbar {
            width: 8px;
        }
        #chat-window::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        #chat-window::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
   
        #video-feed {
            transform: scaleX(-1);
        }
    </style>
</head>
<body class="flex flex-col items-center">
    <div class="flex flex-col h-screen bg-slate-50 font-sans max-w-md w-full mx-auto border-x border-gray-200 shadow-2xl">                <div id="header" class="bg-white p-4 shadow-sm flex items-center justify-between sticky top-0 z-10">
            <div class="flex items-center space-x-3">
                <button 
    onclick="window.location.href='https://codeonly-lab.github.io/prototype0/'" 
    class="p-2 hover:bg-gray-100 rounded-full text-slate-600"
    aria-label="Go back to Main Site"
>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>
</button>
                <div>
                    <h1 class="text-lg font-bold text-slate-800">AI Companion</h1>
                    <div class="flex items-center space-x-1">
                        <span id="status-dot" class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span id="status-text" class="text-xs text-slate-500">Online</span>
                    </div>
                </div>
            </div>
            <button id="stop-speaking-button" class="hidden text-red-500 bg-red-50 px-3 py-1 rounded-full text-sm font-semibold items-center space-x-1 animate-pulse">
                <svg xmlns="https://codeonly-lab.github.io/prototype0" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></svg>
                <span>Stop Audio</span>
            </button>
        </div>

        <div id="camera-container" class="bg-gray-800 p-2 relative hidden">
            <video 
               id="video-feed"
              autoplay 
               playsinline 
               muted
              class="w-full rounded-lg shadow-xl"
            ></video>
            <div class="absolute inset-x-0 bottom-4 flex justify-center">
                <button
                    id="capture-shortcut-button"
                    class="flex items-center space-x-2 bg-blue-500 text-white px-5 py-3 rounded-full shadow-2xl hover:bg-blue-600 transition-transform transform hover:scale-105 active:scale-95"
                    aria-label="Capture and Describe Scene Shortcut: Triple Shift Key"
                >
                    <svg xmlns="https://codeonly-lab.github.io/prototype0/" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></svg>
                    <span class="font-semibold text-lg">Capture & Describe</span>
                </button>
            </div>
        </div>
                <canvas id="capture-canvas" style="display: none;"></canvas>

        <div id="chat-window" class="flex-1 p-4 space-y-6">
            </div>

        <div class="bg-white p-4 border-t border-gray-100 sticky bottom-0">
            <div class="flex items-center space-x-2">
                                <button 
                     id="mic-button"
                    class="p-4 rounded-full transition-all duration-300 shadow-lg flex-shrink-0 bg-slate-100 text-slate-600 hover:bg-slate-200"
                >
                    <svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                </button>
                                <button 
                     id="camera-toggle-button"
                    class="p-4 rounded-full transition-colors flex-shrink-0 shadow-lg bg-slate-100 text-slate-600 hover:bg-slate-200"
                    aria-label="Toggle Vision Assistance"
                >
                    <svg id="camera-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-12a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h.5"/><path d="M2 7l.4 1A2 2 0 0 0 4 9h16a2 2 0 0 0 1.6-1l.4-1"/><path d="M12 18a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/></svg>
                </button>

                <div class="flex-1 relative">
                    <input
                      type="text"
                      id="input-text"
                      placeholder="Type or speak (Triple-tap Q for voice)..."
                      class="w-full pl-4 pr-10 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                    />
                </div>

                <button 
                     id="send-button"
                    disabled
                    class="p-3 bg-blue-600 text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                </button>
            </div>
            <p id="info-text" class="text-center text-xs text-gray-400 mt-2">
                Camera Inactive. Triple-tap Shift for instant vision description.
            </p>
        </div>
    </div>

    <script type="module">
    
        const API_KEY = "AIzaSyC_i364x1yzU7iGaLEGUHnubLP58-vbDnY"; 
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const SYSTEM_INSTRUCTION = {
            parts: [{ text: "You are a highly empathetic, concise, and helpful AI Companion for an individual with mixed physical and cognitive disabilities. Your tone should be supportive, non-judgemental, and clear. If you receive an image, prioritize describing the objects, text, and context in a simple, direct manner. **Always use simple Markdown formatting, such as bolding key terms or using double line breaks to separate ideas, to improve readability.** If the user expresses distress, offer gentle comfort or suggest a practical next step (like contacting a named emergency contact)." }]
        };
        const SHORTCUT_THRESHOLD_MS = 500; 

     
        let messages = [
            { id: 1, sender: 'bot', text: "Hi, I'm here for you. Tap the microphone (or **triple-tap Q**) to speak, the camera to activate vision assistance (or **triple-tap Shift**), or type a message." }
        ];
        let isListening = false;
        let isSpeaking = false;
        let isLoading = false;
        let isCameraActive = false;
        let stream = null;
            
        const shiftPresses = { count: 0, lastPress: 0 };
        const qPresses = { count: 0, lastPress: 0 };
                let recognition = null;

        const $chatWindow = document.getElementById('chat-window');
        const $inputText = document.getElementById('input-text');
        const $micButton = document.getElementById('mic-button');
        const $sendButton = document.getElementById('send-button');
        const $cameraToggleButton = document.getElementById('camera-toggle-button');
        const $cameraContainer = document.getElementById('camera-container');
        const $videoFeed = document.getElementById('video-feed');
        const $captureCanvas = document.getElementById('capture-canvas');
        const $stopSpeakingButton = document.getElementById('stop-speaking-button');
        const $statusDot = document.getElementById('status-dot');
        const $statusText = document.getElementById('status-text');
        const $infoText = document.getElementById('info-text');


    
        const fetchWithRetry = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response.json();
                    }
                    if (response.status === 429) { 
                         throw new Error('Rate limit exceeded');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error; 
                     const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        };

       
        const formatMarkdown = (text) => {
   
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
           
            html = html.replace(/\n/g, '<br/>');
            return html;
        };

        const callGeminiAPI = async (userText, imageForAnalysis = null) => {
            const parts = [{ text: userText }];

            if (imageForAnalysis && imageForAnalysis.base64 && imageForAnalysis.mimeType) {
                parts.unshift({
                    inlineData: {
                        data: imageForAnalysis.base64,
                        mimeType: imageForAnalysis.mimeType,
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }],
                systemInstruction: SYSTEM_INSTRUCTION,
                tools: [{ "google_search": {} }],
            };

            try {
                const result = await fetchWithRetry(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                return result?.candidates?.[0]?.content?.parts?.[0]?.text ||
                                      "I am sorry, I couldn't process that request right now. Please try again or type a simpler question.";
            } catch (error) {
                console.error("Gemini API Error:", error);
                return "I experienced an error connecting to my server. Please check your connection or try again shortly.";
            }
        };
        const updateUI = () => {
           
            if (isListening) {
                $micButton.classList.add('bg-red-500', 'text-white', 'scale-110', 'ring-4', 'ring-red-200');
                $micButton.classList.remove('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
                $micButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`; // Mic icon
                $statusDot.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                $statusText.textContent = 'Listening...';
                $inputText.placeholder = isCameraActive ? "Optional question for the frame..." : "Speak now...";
            } else {
                $micButton.classList.remove('bg-red-500', 'text-white', 'scale-110', 'ring-4', 'ring-red-200');
                $micButton.classList.add('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
                $micButton.innerHTML = `<svg id="mic-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>`;
                if (!isLoading) {
                    $statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    $statusText.textContent = 'Online';
                    $inputText.placeholder = isCameraActive ? "Optional question for the frame..." : "Type or speak (Triple-tap Q for voice)...";
                }
            }

       
            if (isCameraActive) {
                $cameraToggleButton.classList.add('bg-red-600', 'text-white', 'animate-pulse');
                $cameraToggleButton.classList.remove('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
                $cameraToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 16v1a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2c1 0 2-1 3-2l4-2c2 0 3 2 3 4v2"/><line x1="2" x2="22" y1="2" y2="22"/></svg>`; // VideoOff icon
                $cameraContainer.classList.remove('hidden');
                $infoText.textContent = 'Camera Active. Triple-tap Shift or press the "Capture" button for instant description.';
            } else {
                $cameraToggleButton.classList.remove('bg-red-600', 'text-white', 'animate-pulse');
                $cameraToggleButton.classList.add('bg-slate-100', 'text-slate-600', 'hover:bg-slate-200');
                $cameraToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-12a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h.5"/><path d="M2 7l.4 1A2 2 0 0 0 4 9h16a2 2 0 0 0 1.6-1l.4-1"/><path d="M12 18a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/></svg>`; // Camera icon
                $cameraContainer.classList.add('hidden');
                $infoText.textContent = 'Camera Inactive. Triple-tap Shift for instant vision description.';
            }
                      
            if (isSpeaking) {
                $stopSpeakingButton.classList.remove('hidden');
                $stopSpeakingButton.classList.add('flex');
            } else {
                $stopSpeakingButton.classList.add('hidden');
                $stopSpeakingButton.classList.remove('flex');
            }

            if (isLoading) {
                $sendButton.disabled = true;
                $micButton.disabled = true;
                $cameraToggleButton.disabled = true;
                $statusDot.className = 'w-2 h-2 rounded-full bg-yellow-500 animate-pulse';
                $statusText.textContent = 'Thinking...';
            } else {
                $micButton.disabled = false;
                $cameraToggleButton.disabled = false;
                $sendButton.disabled = !$inputText.value.trim() && !isCameraActive;
                if (!isListening) {
                    $statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                    $statusText.textContent = 'Online';
                }
            }
        };

        const renderMessages = () => {
            $chatWindow.innerHTML = '';
            messages.forEach(msg => {
                const messageHtml = `
                    <div class="flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="flex max-w-[85%] ${msg.sender === 'user' ? 'flex-row-reverse' : 'flex-row'} items-end gap-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0
                                 ${msg.sender === 'user' ? 'bg-blue-600 text-white' : 'bg-emerald-500 text-white'}">
                                ${msg.sender === 'user' ?
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>' :
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 12a5 5 0 1 0 0-10 5 5 0 0 0 0 10z"/><path d="M12 17v4"/><path d="M8 21h8"/><path d="M12 17l4 4"/><path d="M12 17l-4 4"/></svg>'}
                            </div>

                            <div class="p-4 rounded-2xl text-lg leading-relaxed shadow-sm
                                ${msg.sender === 'user'
                                ? 'bg-blue-600 text-white rounded-br-none'
                                : 'bg-white text-slate-800 border border-gray-100 rounded-bl-none'}">
                                
                                ${msg.imageUrl ? `
                                    <div class="mb-3 w-full">
                                        <img
                                             src="${msg.imageUrl}"
                                             alt="Captured frame for analysis"
                                             class="w-full max-h-48 object-cover rounded-xl shadow-md"
                                         />
                                    </div>
                                ` : ''}
                                
                                ${formatMarkdown(msg.text)}
                            </div>
                        </div>
                    </div>
                `;
                $chatWindow.insertAdjacentHTML('beforeend', messageHtml);
            });
            if (isLoading) {
                const loadingHtml = `
                    <div class="flex justify-start" id="loading-indicator">
                        <div class="bg-gray-200 text-gray-500 px-4 py-2 rounded-full text-sm animate-pulse">
                            Assistify is thinking...
                        </div>
                    </div>
                `;
                $chatWindow.insertAdjacentHTML('beforeend', loadingHtml);
            }

            $chatWindow.scrollTop = $chatWindow.scrollHeight;
        };

        const updateAndRender = () => {
            updateUI();
            renderMessages();
        };


        const speakText = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                                
                utterance.rate = 0.9; 
                utterance.pitch = 1;
                                
                utterance.onstart = () => { isSpeaking = true; updateAndRender(); };
                utterance.onend = () => { isSpeaking = false; updateAndRender(); };
                                
                window.speechSynthesis.speak(utterance);
            }
        };

        const stopSpeaking = () => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                updateAndRender();
            }
        };

        const toggleListening = () => {
            if (!recognition) {
                console.warn("Speech recognition is not supported in this browser.");
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
            
                if (isCameraActive) {
                    $inputText.focus();
                    messages.push({ id: Date.now(), sender: 'bot', text: "Camera is active. Type your question for the frame, or triple-tap **Q** again to stop listening." });
                    updateAndRender();
                    return;
                }
                                
            
                isListening = true;
                updateAndRender();
                try {
                    recognition.start();
                } catch (e) {
                    console.error("Recognition start failed:", e);
                    isListening = false;
                    updateAndRender();
                    messages.push({ id: Date.now(), sender: 'bot', text: "**Voice Error:** The microphone is already in use or access was denied. Please try again." });
                    updateAndRender();
                }
            }
        };

                
        const startCamera = async () => {
            if (isCameraActive) return;

            try {
           
                if (isListening) {
                    recognition.stop(); 
                }
                                
                const mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                $videoFeed.srcObject = mediaStream;
                stream = mediaStream;
                isCameraActive = true;
                updateAndRender();
            } catch (err) {
                console.error("Error accessing camera:", err);
                messages.push({ id: Date.now() + 99, sender: 'bot', text: "**Camera Error:** I couldn't access your camera. Please check permissions." });
                isCameraActive = false;
                updateAndRender();
            }
        };

        const stopCamera = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            isCameraActive = false;
            updateAndRender();
        };

        const captureAndSendFrame = async (text = "") => {
            if (!$videoFeed || !$captureCanvas || $videoFeed.readyState < 2) { 
                 messages.push({ id: Date.now() + 1, sender: 'bot', text: "The camera feed isn't ready yet. Please wait a moment and try again." });
                stopCamera();
                updateAndRender();
                return;
            }

            $captureCanvas.width = $videoFeed.videoWidth;
            $captureCanvas.height = $videoFeed.videoHeight;
            const ctx = $captureCanvas.getContext('2d');


            ctx.drawImage($videoFeed, 0, 0, $captureCanvas.width, $captureCanvas.height);


            const dataUrl = $captureCanvas.toDataURL('image/jpeg', 0.8);
            const mimeType = 'image/jpeg';
            const base64String = dataUrl.split(',')[1];
                        
       
            const userPrompt = text.trim() || "Please describe the surroundings in this frame, focusing on potential hazards, objects, or text.";
                        
        
            const userMsg = { 
                 id: Date.now(), 
                 sender: 'user', 
                 text: `[Visual Request] ${userPrompt}`,
                imageUrl: dataUrl
            };
            messages.push(userMsg);
            $inputText.value = '';
            isLoading = true;
            updateAndRender();

           
            stopCamera();

          
            try {
                const imageForAnalysis = { base64: base64String, mimeType: mimeType };
                const responseText = await callGeminiAPI(userPrompt, imageForAnalysis);
                                 
               
                const botMsg = { id: Date.now() + 1, sender: 'bot', text: responseText };
                messages.push(botMsg);
                speakText(responseText);
            } catch (error) {
                console.error("Multimodal API Error:", error);
                messages.push({ id: Date.now() + 2, sender: 'bot', text: "I apologize, the vision analysis failed. Please try capturing the image again." });
            } finally {
                isLoading = false;
                updateAndRender();
            }
        };

       
        const handleSendMessage = async (textOverride = null) => {
            const text = textOverride || $inputText.value;
                        
            if (isCameraActive) {
                await captureAndSendFrame(text);
                return;
            }
                        

            if (!text.trim()) return; 
                         
            stopSpeaking(); 

            const userMsg = { id: Date.now(), sender: 'user', text: text };
            messages.push(userMsg);
            $inputText.value = '';
            isLoading = true;
            updateAndRender();

            try {
                const responseText = await callGeminiAPI(text, null);

                const botMsg = { id: Date.now() + 1, sender: 'bot', text: responseText };
                messages.push(botMsg);
         
                speakText(responseText);
            } catch (error) {
                console.error("Error during message processing:", error);
                messages.push({ id: Date.now() + 2, sender: 'bot', text: "I apologize, there was an issue processing your request." });
            } finally {
                isLoading = false;
                updateAndRender();
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
          
            updateAndRender();

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    $inputText.value = transcript;
                    updateUI();
                    if (!isCameraActive) {
                        handleSendMessage(transcript); 
                    } else {
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    updateAndRender();
                };
                                
                recognition.onerror = (event) => {
                    console.error("Speech Recognition Error:", event.error);
                    isListening = false;
                    updateAndRender();
                    if (event.error !== 'no-speech') {
                        messages.push({ id: Date.now(), sender: 'bot', text: `**Voice Error:** ${event.error}. Please try again.` });
                        updateAndRender();
                    }
                };
            } else {
                console.warn("Speech recognition is not supported in this browser.");
                $micButton.disabled = true;
            }

    
            $micButton.addEventListener('click', toggleListening);
            $stopSpeakingButton.addEventListener('click', stopSpeaking);
            $cameraToggleButton.addEventListener('click', isCameraActive ? stopCamera : startCamera);
                        
            $inputText.addEventListener('input', updateUI); 
            $inputText.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });

            $sendButton.addEventListener('click', () => handleSendMessage());
                        
    
            document.getElementById('capture-shortcut-button').addEventListener('click', () => {
                if (isCameraActive && !isLoading) {
                    captureAndSendFrame($inputText.value);
                }
            });

            window.addEventListener('keyup', (event) => {
                const key = event.key;
                const lowerKey = key.toLowerCase();
                const now = Date.now();
                const activeElement = document.activeElement;
                const isInputActive = activeElement === $inputText || activeElement.tagName === 'TEXTAREA';

                              if (isInputActive && lowerKey !== 'q' && key !== 'Shift') {
                    return;
                }
                                
                if (key === 'Shift') {
                    const presses = shiftPresses;
                    if (now - presses.lastPress < SHORTCUT_THRESHOLD_MS) {
                        presses.count += 1;
                    } else {
                        presses.count = 1;
                    }
                }
                
                if (lowerKey === 'q') {
                    const presses = qPresses;
                    if (now - presses.lastPress < SHORTCUT_THRESHOLD_MS) {
                        presses.count += 1;
                    } else {
                        presses.count = 1;
                    }
                }

            
                if (key === 'Shift' && shiftPresses.count === 3 && !isLoading) {
                    shiftPresses.count = 0; 
                    if (!isCameraActive) {
                        startCamera().then(() => {
                           
                            setTimeout(() => {
                                captureAndSendFrame();
                            }, 500); 
                        });
                    } else {
                     
                        captureAndSendFrame($inputText.value);
                    }
                }

               
                if (lowerKey === 'q' && qPresses.count === 3 && !isLoading) {
                    qPresses.count = 0; 
                    toggleListening();
                }

            
                if (key === 'Shift') {
                    shiftPresses.lastPress = now;
                }
                if (lowerKey === 'q') {
                    qPresses.lastPress = now;
                }
            });
        });
    </script>
</body>

</html>

	




